<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Chat OpenRouter</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { margin: 0; background: #343541; font-family: 'Segoe UI', Arial, sans-serif; display: flex; justify-content: center; height: 100vh; }
        .chat-wrapper { width: 100%; max-width: 850px; display: flex; flex-direction: column; height: 100vh; }
        .messages { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; }
        .message { margin-bottom: 25px; line-height: 1.6; color: #ececf1; }
        .user { text-align: right; background: #444654; padding: 12px 18px; border-radius: 15px; margin-left: auto; max-width: 80%; border: 1px solid #565869; }
        .assistant { background: #444654; padding: 20px; border-radius: 8px; border: 1px solid #565869; position: relative; }
        
        /* Estilo para Tabelas e CÃ³digos */
        .assistant table { border-collapse: collapse; width: 100%; margin: 15px 0; background: #2d2e37; }
        .assistant th, .assistant td { border: 1px solid #565869; padding: 10px; text-align: left; }
        .assistant pre { background: #000; padding: 15px; overflow-x: auto; border-radius: 5px; border: 1px solid #333; }
        .assistant code { font-family: 'Consolas', monospace; color: #e2e2e2; }

        .copy-btn { margin-top: 15px; background: #19c37d; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; transition: 0.2s; }
        .copy-btn:hover { background: #1aae71; }
        
        .input-area { display: flex; padding: 25px; background: #40414f; gap: 10px; }
        input { flex: 1; padding: 15px; border-radius: 6px; border: 1px solid #565869; background: #40414f; color: white; font-size: 16px; outline: none; }
        button.send-btn { padding: 0 25px; border-radius: 6px; border: none; background: #19c37d; color: white; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="chat-wrapper">
    <div class="messages" id="messages"></div>
    <div class="input-area">
        <input id="userInput" placeholder="Digite sua mensagem..." autofocus />
        <button class="send-btn" onclick="sendMessage()">Enviar</button>
    </div>
</div>

<script>
const messagesDiv = document.getElementById("messages");
const userInput = document.getElementById("userInput");

// 1) Adiciona a saudaÃ§Ã£o inicial se o chat estiver vazio
let conversation = JSON.parse(localStorage.getItem("chat_history")) || [];

if (conversation.length === 0) {
    conversation.push({ role: "system", content: "VocÃª Ã© um assistente especialista. Responda em portuguÃªs e use Markdown." });
    // Mensagem visual de boas-vindas
    setTimeout(() => {
        addMessage("OlÃ¡! Qual sua dÃºvida?", "assistant", false);
    }, 500);
}

function stripMarkdown(text) {
    // Remove marcaÃ§Ãµes de negrito, itÃ¡lico, links e blocos de cÃ³digo para o Word nÃ£o pirar
    return text
        .replace(/\*\*\*(.*?)\*\*\*/g, '$1')
        .replace(/\*\*(.*?)\*\*/g, '$1')
        .replace(/\*(.*?)\*/g, '$1')
        .replace(/`{3,}.*?\n([\s\S]*?)\n`{3,}/g, '$1')
        .replace(/`(.*?)`/g, '$1')
        .replace(/\[(.*?)\]\(.*?\)/g, '$1');
}

function addMessage(content, role, save = true) {
    const div = document.createElement("div");
    div.classList.add("message", role);
    const inner = document.createElement("div");
    
    // Renderiza MD se for assistente
    inner.innerHTML = role === "assistant" ? marked.parse(content) : content;
    div.appendChild(inner);
    
    if (role === "assistant") {
        const btn = document.createElement("button");
        btn.className = "copy-btn";
        btn.innerText = "ðŸ“‹ Copiar para Word";
        btn.onclick = () => {
            const rawText = div.getAttribute("data-raw") || content;
            const cleanText = stripMarkdown(rawText); // Limpa o MD antes de copiar
            navigator.clipboard.writeText(cleanText);
            btn.innerText = "âœ… Texto Limpo!";
            setTimeout(() => btn.innerText = "ðŸ“‹ Copiar para Word", 2000);
        };
        div.appendChild(btn);
    }
    
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    if (save && role !== "system") {
        div.setAttribute("data-raw", content);
    }
    return inner;
}

async function sendMessage() {
    const text = userInput.value.trim();
    if (!text) return;
    userInput.value = "";

    addMessage(text, "user");
    conversation.push({ role: "user", content: text });

    const assistantDiv = addMessage("", "assistant");
    const parentWrapper = assistantDiv.parentElement;
    let fullText = "";

    try {
        const response = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                model: "openrouter/free",
                messages: conversation,
                stream: true
            })
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let partialChunk = "";

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            partialChunk += decoder.decode(value, { stream: true });
            let lines = partialChunk.split("\n");
            partialChunk = lines.pop();

            for (const line of lines) {
                const trimmed = line.replace(/^data: /, "").trim();
                if (!trimmed || trimmed === "[DONE]") continue;

                try {
                    if (trimmed.startsWith('{')) {
                        const json = JSON.parse(trimmed);
                        const content = json.choices[0]?.delta?.content || "";
                        fullText += content;
                        
                        assistantDiv.innerHTML = marked.parse(fullText);
                        parentWrapper.setAttribute("data-raw", fullText);
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }
                } catch (e) {}
            }
        }

        conversation.push({ role: "assistant", content: fullText });
        localStorage.setItem("chat_history", JSON.stringify(conversation));

    } catch (err) {
        assistantDiv.innerText = "Erro: " + err.message;
    }
}

userInput.addEventListener("keypress", e => { if(e.key === 'Enter') sendMessage(); });

// Carrega histÃ³rico existente
if (conversation.length > 1) {
    conversation.forEach(m => {
        if (m.role !== 'system') {
            const el = addMessage(m.content, m.role, false);
            el.parentElement.setAttribute("data-raw", m.content);
        }
    });
}
</script>
</body>
</html>
